#!/bin/bash

# Setup Android SDK for Flutter Development
# This script creates proper Android SDK structure and symlinks

echo "ğŸ¤– Setting up Android SDK for Flutter development..."

# Set Android SDK location
ANDROID_HOME="${HOME}/Library/Android/sdk"
HOMEBREW_PREFIX="/opt/homebrew"

# Create Android SDK directory structure
echo "ğŸ“ Creating Android SDK directory structure..."
mkdir -p "$ANDROID_HOME"

# Link cmdline-tools from Homebrew (needed to bootstrap SDK installation)
echo "ğŸ”— Linking cmdline-tools from Homebrew..."
if [ ! -L "$ANDROID_HOME/cmdline-tools" ]; then
    ln -sf "$HOMEBREW_PREFIX/share/android-commandlinetools/cmdline-tools" "$ANDROID_HOME/cmdline-tools"
    echo "âœ… Linked cmdline-tools"
fi

# Use SDK manager to install essential packages directly into ANDROID_HOME
echo "ğŸ“¦ Installing essential Android SDK packages..."
export ANDROID_SDK_ROOT="$ANDROID_HOME"
"$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_HOME" --install \
    "platform-tools" \
    "build-tools;34.0.0" \
    "platforms;android-34" \
    "emulator" \
    "system-images;android-34;google_apis;arm64-v8a" \
    "system-images;android-34;google_apis_playstore;arm64-v8a"

# Accept all licenses
echo "ğŸ“‹ Accepting Android SDK licenses..."
yes | "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_HOME" --licenses

# Create a basic AVD for development
echo "ğŸ“± Creating Android Virtual Device..."
AVD_NAME="Pixel_8_Pro_API_34"

# Check if AVD already exists
if ! "$ANDROID_HOME/cmdline-tools/latest/bin/avdmanager" list avd | grep -q "$AVD_NAME"; then
    echo "Creating AVD: $AVD_NAME"
    echo "no" | "$ANDROID_HOME/cmdline-tools/latest/bin/avdmanager" create avd \
        -n "$AVD_NAME" \
        -k "system-images;android-34;google_apis_playstore;arm64-v8a" \
        -d "pixel_8_pro"
    echo "âœ… Created AVD: $AVD_NAME"
else
    echo "âœ… AVD already exists: $AVD_NAME"
fi

# Verify setup
echo "ğŸ” Verifying Android SDK setup..."
ls -la "$ANDROID_HOME"

echo "ğŸ“‹ Installed SDK packages:"
"$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --list_installed

echo "ğŸ“± Available AVDs:"
"$ANDROID_HOME/cmdline-tools/latest/bin/avdmanager" list avd


echo "ğŸ‰ Android SDK setup complete!"
echo ""
echo "ğŸ’¡ Quick commands:"
echo "  â€¢ List AVDs: $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager list avd"
echo "  â€¢ Start AVD: $ANDROID_HOME/emulator/emulator -avd $AVD_NAME"
echo "  â€¢ Flutter devices: flutter devices"
echo "  â€¢ Flutter emulators: flutter emulators"
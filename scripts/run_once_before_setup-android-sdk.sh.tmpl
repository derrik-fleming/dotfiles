#!/bin/bash

# Setup Android SDK for Flutter Development using Homebrew packages
# This script creates proper Android SDK structure using Homebrew-installed components

echo "ü§ñ Setting up Android SDK for Flutter development with Homebrew packages..."

# Use Homebrew Android SDK location
ANDROID_HOME="/opt/homebrew/share/android-commandlinetools"
HOMEBREW_PREFIX="/opt/homebrew"

# Ensure the base Android SDK directory exists
echo "üìÅ Ensuring Android SDK directory structure..."
mkdir -p "$ANDROID_HOME"

# Link platform-tools from Homebrew Cask
echo "üîó Linking platform-tools from Homebrew..."
if [ ! -L "$ANDROID_HOME/platform-tools" ]; then
    # Find the actual platform-tools version directory
    PLATFORM_TOOLS_DIR=$(find "$HOMEBREW_PREFIX/Caskroom/android-platform-tools" -name "platform-tools" -type d | head -1)
    if [ -n "$PLATFORM_TOOLS_DIR" ]; then
        ln -sf "$PLATFORM_TOOLS_DIR" "$ANDROID_HOME/platform-tools"
        echo "‚úÖ Linked platform-tools from Homebrew Cask"
    else
        echo "‚ùå Could not find platform-tools directory"
        exit 1
    fi
fi

# Use SDK manager to install essential packages for emulator
echo "üì¶ Installing essential Android SDK packages..."
export ANDROID_SDK_ROOT="$ANDROID_HOME"
"$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_HOME" --install \
    "build-tools;34.0.0" \
    "platforms;android-34" \
    "emulator" \
    "system-images;android-34;google_apis_playstore;arm64-v8a"

# Accept all licenses
echo "üìã Accepting Android SDK licenses..."
yes | "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_HOME" --licenses

# Create a basic AVD for development
echo "üì± Creating Android Virtual Device..."
AVD_NAME="Pixel_8_Pro_API_34"

# Check if AVD already exists
if ! "$ANDROID_HOME/cmdline-tools/latest/bin/avdmanager" list avd | grep -q "$AVD_NAME"; then
    echo "Creating AVD: $AVD_NAME"
    echo "no" | "$ANDROID_HOME/cmdline-tools/latest/bin/avdmanager" create avd \
        -n "$AVD_NAME" \
        -k "system-images;android-34;google_apis_playstore;arm64-v8a" \
        -d "pixel_8_pro"
    echo "‚úÖ Created AVD: $AVD_NAME"
else
    echo "‚úÖ AVD already exists: $AVD_NAME"
fi

# Verify setup
echo "üîç Verifying Android SDK setup..."
ls -la "$ANDROID_HOME"

echo "üìã Installed SDK packages:"
"$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --list_installed

echo "üì± Available AVDs:"
"$ANDROID_HOME/cmdline-tools/latest/bin/avdmanager" list avd


# Configure Flutter to use this Android SDK
echo "üîß Configuring Flutter to use Homebrew Android SDK..."
flutter config --android-sdk "$ANDROID_HOME"

echo "üéâ Android SDK setup complete!"
echo ""
echo "üí° Your Android SDK is managed by Homebrew with emulator support:"
echo "  ‚Ä¢ Command line tools: android-commandlinetools cask"
echo "  ‚Ä¢ Platform tools: android-platform-tools cask"
echo "  ‚Ä¢ Emulator and system images: installed via sdkmanager"
echo ""
echo "üí° Quick commands:"
echo "  ‚Ä¢ Check Flutter: flutter doctor"
echo "  ‚Ä¢ List AVDs: $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager list avd"
echo "  ‚Ä¢ Start AVD: $ANDROID_HOME/emulator/emulator -avd $AVD_NAME"
echo "  ‚Ä¢ Flutter devices: flutter devices"
echo "  ‚Ä¢ Flutter emulators: flutter emulators"
echo "  ‚Ä¢ Update Homebrew tools: brew upgrade --cask android-commandlinetools android-platform-tools"
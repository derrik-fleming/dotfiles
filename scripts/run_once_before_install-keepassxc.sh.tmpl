#!/bin/bash

# Install KeePassXC if not already installed using 1Password CLI for sudo password
# This runs before other chezmoi operations

if ! brew list --cask keepassxc &>/dev/null; then
    echo "üì¶ Installing KeePassXC password manager..."
    
    # Get sudo password from 1Password
    if command -v op &> /dev/null; then
        echo "üîê Getting sudo password from 1Password..."
        SUDO_PASS=$(op read "op://Private/gentex-login/password" 2>/dev/null)
        
        if [ -n "$SUDO_PASS" ]; then
            echo "‚úÖ Retrieved password from 1Password"
            echo "$SUDO_PASS" | sudo -S brew install --cask keepassxc
        else
            echo "‚ùå Could not retrieve password from 1Password"
            echo "Falling back to interactive sudo..."
            brew install --cask keepassxc
        fi
    else
        echo "‚ö†Ô∏è  1Password CLI not found, using interactive sudo..."
        brew install --cask keepassxc
    fi
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ KeePassXC installed successfully"
        echo "üí° CLI is available as: keepassxc-cli"
    else
        echo "‚ùå KeePassXC installation failed"
        echo "You can install manually: brew install --cask keepassxc"
    fi
else
    echo "‚úÖ KeePassXC already installed"
fi